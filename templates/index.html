<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>The Galactic P2P Chatroom</title>

    <style>
        * { font-family:tahoma; font-size:12px; padding:0px; margin:0px; }
        p { line-height:18px; }
        div { width:500px; margin-left:auto; margin-right:auto;}
        #content { padding:5px; background:#ddd; border-radius:5px; overflow-y: scroll;
                   border:1px solid #CCC; margin-top:10px; height: 160px; }
        #input { border-radius:2px; border:1px solid #ccc;
                 margin-top:10px; padding:5px; width:400px;  }
        #status { width:88px; display:block; float:left; margin-top:15px; }
        #button { width:20px; display:block; float:right; margin-top:10px; }
    </style>
    <script type="text/javascript" src="static/js/socket.io/socket.io.js"></script>
    <script>
        window.addEventListener('load', function () {
            var input = document.getElementById('input');
            var output = document.getElementById('output');
            var state = document.getElementById('status'); 
            var socket = io(document.location.host, {'session': 'data'});


            /*
             * connection/disconnection handlers
             */
            socket.on('connect', function(){
                console.log('connected to signaling server');
                input.removeAttribute('disabled');
                }).on('disconnect', function(){
                console.log('disconnected from signaling server');
                input.setAttribute('disabled', 'disabled');
            });


            /*
             * socket session handler 
             */
            socket.on('session', function(message){
                if (window.sessionStorage['token'] == undefined) {
                    var token = message.token;
                    window.sessionStorage.setItem('token', token);
                    socket.emit('session', {
                        'token': message.token
                    });
                } else {
                    // if there is a name, tell server
                    var token = window.sessionStorage['token'];
                    socket.emit('session', {
                        'token': token
                    });                   
                }
                    
            });

            socket.on('message', function(message){
                if (message.greeting)
                    console.log(message.greeting);
            });

            window.beforeunload = function(){
                 socket.close();
            };

            input.onkeypress = function(e) {
		       if (e.keyCode == 13) {
                   var message = {};
                   message.payload = input.value;
                   console.log('Sending message', message);
                   socket.emit('message', JSON.stringify(message));
                   return false;
               }
            };
        });
    </script>
    <body>
        <div id="content"></div>
        <div>
            <span id="status">welcome</span>
            <input type="text" id="input" disabled="disabled"/>
        </div>
    </body>
</head>
</html>

